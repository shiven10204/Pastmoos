<!DOCTYPE html>
<html>
<head>
	<title>Pastmoos- Login/Sign Up</title>
	<link rel="stylesheet" type="text/css" href="login/css/style.css">
	<link href="https://fonts.googleapis.com/css?family=Poppins:600&display=swap" rel="stylesheet">
	<!-- <script src="https://kit.fontawesome.com/a81368914c.js"></script> -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
	<img class="wave" src="login/img/wave.png">
	<div class="container">
		<div class="img">
			<img src="login/img/groupop.png">
		</div>
		<div class="login-content">
			<div class="form">
				<img src="login/img/logo final.png">
				<h2 class="title">Welcome</h2>
    <p id="errorp" style="color:red;"></p>

           		<div class="input-div one" id="phdiv">
           		   <div class="i">
           		   		<i class="fas fa-user"></i>
           		   </div>
				   
           		   <div class="div" >
           		   		<h5>Phone Number</h5>
							  <input type="text" class="input" placeholder="+91" style="position: absolute;  margin-left: -40px;">
							  <input type="tel" id="phoneNumber" class="input" >
           		   </div>
				   
           		</div>
				   <input type="submit" class="btn" id="sign-in-button" value="Get OTP" onclick="validatePhoneNumber()" >
           		<div class="input-div pass" id="otpdiv">
           		   <div class="i"> 
           		    	<i class="fas fa-lock"></i>
           		   </div>
           		   <div class="div">
           		    	<h5>OTP</h5>
           		    	<input type="otp" class="input" id="code" maxlength="6">
            	   </div>
				 

            	</div>
				<p id="resend-otp-timer"></p>
				<p id="resend-otp-button"  style="display:none; color:purple; cursor: pointer;" onclick="resendOTP()">Resend OTP</p>
            	
            	<input type="submit" class="btn" value="Verify" id="confirm-code" onclick="validateotp()">
            </div>
        </div>
    </div>
    <div id="recaptcha-container"></div>  
	<div class="main div">

  











    </div>
	<div>
	<img class="wave2" src="login/img/footerop.png">
</div>
    <script type="text/javascript" src="login/js/main.js"></script>
	 <!-- Add the latest firebase dependecies from CDN -->
	 <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
	 <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
 
	 <script>
	   // Place your config here
	   var firebaseConfig = {
		apiKey: "AIzaSyBQ75mL_tGG7DHgjh3u0_n_m-H6i3Qg_xM",
   authDomain: "test-pastmoos.firebaseapp.com",
   databaseURL: "https://test-pastmoos-default-rtdb.firebaseio.com",
   projectId: "test-pastmoos",
   storageBucket: "test-pastmoos.appspot.com",
   messagingSenderId: "130244640247",
   appId: "1:130244640247:web:62192c97a93d81ba95c2f2",
   measurementId: "G-XFD7NKTDZV"
	   };
 
	   firebase.initializeApp(firebaseConfig);
 
	   // Create a Recaptcha verifier instance globally
	   // Calls submitPhoneNumberAuth() when the captcha is verified
	   window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
		 "recaptcha-container",
		 {
		   size: "invisible",
		   callback: function(response) {
			 submitPhoneNumberAuth();
		   }
		 }
	   );
 
	   // This function runs when the 'sign-in-button' is clicked
	   // Takes the value from the 'phoneNumber' input and sends SMS to that phone number
	   function submitPhoneNumberAuth() {
		startTimer();

		 var phoneNumber = '+91'+ document.getElementById("phoneNumber").value;
	   document.getElementById('phdiv').style.display='none';
	   document.getElementById('sign-in-button').style.display='none';
     document.getElementById('otpdiv').style.display='block';
document.getElementById('confirm-code').style.display='block';

		 var appVerifier = window.recaptchaVerifier;
		 firebase
		   .auth()
		   .signInWithPhoneNumber(phoneNumber, appVerifier)
		   .then(function(confirmationResult) {
			 window.confirmationResult = confirmationResult;
		   })
		   .catch(function(error) {
			 console.log(error);
      
		   });
		   setTimeout(function() {
    document.getElementById('resend-otp-button').style.display = 'block';
  }, 60000);
	   }
 
	   // This function runs when the 'confirm-code' button is clicked
	   // Takes the value from the 'code' input and submits the code to verify the phone number
	   // Return a user object if the authentication was successful, and auth is complete
	   function submitPhoneNumberAuthCode() {

		 var code = document.getElementById("code").value;
		 confirmationResult
		   .confirm(code)
		   .then(function(result) {
			 var user = result.user;
			 //;
			//  document.getElementById("done").innerHTML = "OTP completed";
			 // window.AppInventor.setWebViewString(JSON.stringify(user));
			 window.location.href = 'index.html';
		   })
		   .catch(function(error) {
			 console.log(error);
       document.getElementById('errorp').innerHTML=`${error}`;
		   
		   });
	   }

	   // Set the countdown timer duration (in seconds)
	   const timerDuration = 60;

// Get references to the HTML elements
const resendOtpBtn = document.getElementById('resend-otp-button');
const resendOtpTimer = document.getElementById('resend-otp-timer');

// Function to start the countdown timer
function startTimer() {
	
  let remainingTime = timerDuration;
  resendOtpTimer.innerText = `Resend OTP in ${remainingTime} seconds`;

  // Decrement the remaining time every second
  const timer = setInterval(() => {
    remainingTime--;
    resendOtpTimer.innerText = `Resend OTP in ${remainingTime} seconds`;

    if (remainingTime === 0) {
      clearInterval(timer);
      resendOtpBtn.style.display = 'inline-block';
      resendOtpTimer.style.display = 'none';
    }
  }, 1000);

  resendOtpBtn.style.display = 'none';
  resendOtpTimer.style.display = 'inline-block';
}

	   function resendOTP() {
  var phoneNumber = '+91' + document.getElementById("phoneNumber").value;
  var appVerifier = window.recaptchaVerifier;

  // Re-send the OTP
  firebase.auth().signInWithPhoneNumber(phoneNumber, appVerifier)
    .then(function(confirmationResult) {
      window.confirmationResult = confirmationResult;
      // Hide the resend button
      document.getElementById('resend-otp-button').style.display = 'none';
    })
    .catch(function(error) {
      console.log(error);
    });
}

 
	   //This function runs everytime the auth state changes. Use to verify if the user is logged in
	   firebase.auth().onAuthStateChanged(function(user) {
		 if (user) {
		   console.log("USER LOGGED IN");
		   console.log(user.phoneNumber);
		   
		 } else {
		   // No user is signed in.
		   console.log("USER NOT LOGGED IN");
		 }
	   });
	 </script>
   <script>

document.getElementById('otpdiv').style.display='none';
document.getElementById('confirm-code').style.display='none';
function validatePhoneNumber() {
      var phoneNumber = document.getElementById("phoneNumber").value;
      var phonePattern = /^\d{10}$/; // Regular expression to validate phone number in format xxx-xxx-xxxx
      if (!phonePattern.test(phoneNumber)) {
        alert("Please enter a valid phone number in the format xxx-xxx-xxxx.");
        return false;
      } else{
        submitPhoneNumberAuth();

      return true;
      }
    }
    function validateotp() {
      var otp = document.getElementById("code").value;
      var otpPattern = /^\d{6}$/; // Regular expression to validate phone number in format xxx-xxx-xxxx
      if (!otpPattern.test(otp)) {
        alert("Please enter a valid otp in the format xxxxxx.");
        return false;
      } else{
        submitPhoneNumberAuthCode();

      return true;
      }
    }



   </script>
</body>
</html>
