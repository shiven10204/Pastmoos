<!DOCTYPE html>
<html>
<head>
	<title>Form Example</title>
       <!-- CSS FILES -->        
       <link rel="preconnect" href="https://fonts.googleapis.com">
        
       <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

       <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400&family=Sono:wght@200;300;400;500;700&display=swap" rel="stylesheet">
                       
       <link rel="stylesheet" href="css/bootstrap.min.css">

       <link rel="stylesheet" href="css/bootstrap-icons.css">

       <link rel="stylesheet" href="css/owl.carousel.min.css">
       
       <link rel="stylesheet" href="css/owl.theme.default.min.css">

       <link href="css/templatemo-pod-talk.css" rel="stylesheet">
	<style>
    .topaydiv{
width:60%;

    }
        .billing {
			margin: 0 auto;
			width: 70%;
		}
		table {
			width: 100%;
		}
		label {
			display: block;
			margin-top: 10px;
		}
		input[type="text"], input[type="email"], input[type="password"], select {
			width: 50%;
			padding: 5px;
			border-radius: 15px;
			border: 1px solid #ccc;
			margin-top: 5px;
			margin-bottom: 5px;
      font-size: large;


		}
		input[type="submit"] {
			background-color: #4CAF50;
			color: white;
			padding: 12px 20px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}
		input[type="submit"]:hover {
			background-color: #45a049;
		}
    .wave{
	position: fixed;
	bottom: 0;
	left: 0;
	height: 100%;
	z-index: -1;
}
.wave2{
	position: fixed;
	bottom: 0;
	right: 0;
	height: 100%;
	z-index: -1;
  -webkit-transform: scaleX(-1);
  transform: scaleX(-1);
}
.table{
  background-color: aliceblue;
  border-radius: 10px;
}
.total{
  font-size: xxx-large;
}
.delbtn{
  width:60%; 
  font-size: larger;
}
.label{
      font-weight:bolder;
    }
@media screen and (max-width: 990px) {
.wave,.wave2{
height:20%;
}
.topaydiv {
        width: 100%;
    }

    .billing {
        width: 90%;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    select {
        width: 100%;
        margin-bottom: 10px;
        font-size: xx-large;
    }

    input[type="submit"] {
        width: 100%;
        margin-bottom: 20px;
    }
    .label{
      font-size: xx-large;
    }
    .table{
      font-size: x-large;
    }
    .total{
  font-size: xxx-large;
}
    
    
}




	</style>
</head>
<body>
	<img class="wave" src="login/img/wave.png">
	<img class="wave2" src="login/img/wave.png">
  <center>
  <img src="images/logo final.png" width="10%">
  <h1 id="head1">Checkout</h1>
</center>
  <main id="main">


    <center>
     
        <div class="billing">
            <table class="table">
                <thead>
                    <tr>
                        <th>S.no</th>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        <th>Price</th>
                    </tr>
                </thead>
                <tbody class="tabody"> 


                </tbody>
                </table>
                <h3 id="total" class="total"></h3>
                <p ></p>
	<h2>Add Address</h2>
	<div>
		<label for="name" class="label"  >Name:</label>
		<input type="text" id="name" name="name" required>

		<label for="email" class="label" >Email address:</label>
		<input type="email" id="email" name="email" required>

		<label for="pincode" class="label" >Pincode:</label>
		<input type="text" id="pincode" name="pincode" required>

		<label for="address1" class="label" >Address Line 1:</label>
		<input type="text" id="address1" name="address1" required>

		<label for="address2" class="label" >Address Line 2:</label>
		<input type="text" id="address2" name="address2" required>
        <label for="state" class="label" >State:</label>
		<input type="text" id="state" name="state" required>
        <label for="city" class="label" >City:</label>
		<input type="text" id="city" name="city" required>

		<label for="payment" class="label" >Payment option:</label>
		<select id="payment" name="payment" required>
      <option value="cod">Cash on Delivery</option>
			<option value="online">Online</option>
			
		</select>
        <br>
        <p id="totprice" style="display:none;"></p>
        <p id="testp"></p>

		<button  value="Check delivery" onclick="validateForm()" class="btn custom-btn smoothscroll mt-3" id="delbtn" style="width:80%; font-size: x-large; padding: 20px;" >Confirm Address </button>
	</div>
</center>
<center>
<div id="min-rate-details"></div>
<div id="final-amount"></div>
<button onclick="placeorder()" id="placeorderbtn" class="btn custom-btn smoothscroll mt-3" style="width:60%; font-size: x-large; padding: 20px; display:none; margin-bottom: 40px;" >Place Order </button>
</center>
</main>

	<script>
	
	</script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getDatabase, ref, set, get, child, orderByChild, equalTo, query, limitToFirst, limitToLast, startAt, endAt } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";
         
        // Paste the code from Firebase
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
    apiKey: "AIzaSyBQ75mL_tGG7DHgjh3u0_n_m-H6i3Qg_xM",
    authDomain: "test-pastmoos.firebaseapp.com",
    databaseURL: "https://test-pastmoos-default-rtdb.firebaseio.com",
    projectId: "test-pastmoos",
    storageBucket: "test-pastmoos.appspot.com",
    messagingSenderId: "130244640247",
    appId: "1:130244640247:web:62192c97a93d81ba95c2f2",
    measurementId: "G-XFD7NKTDZV"
    };
         
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
         
        // Get a reference to the database service
        const db = getDatabase(app);
      
        
    
    const dbRef = ref(getDatabase());
    const hotdealRef = query(ref(db, `Cart/` ), orderByChild('phone'), equalTo(sessionStorage.getItem('userloggedin')));
    
    get(hotdealRef).then((snapshot) => {
    if (snapshot.exists()) {
    
    var i;
    var counter=(Object.keys(snapshot.val()).length);
    i=0;
    
    
      
    Object.keys(snapshot.val()).forEach((key) => {
    
    
    
    
        document.querySelector(".tabody").innerHTML +=`
            
            <tr>
                <td>${i++} </td>
				<td> ${snapshot.val()[key].productName}</td>
				<td> ${snapshot.val()[key].quant}</td>
				<td> ${snapshot.val()[key].disprice}</td>
			</tr> `;
              
                
                
           


});




} else {
console.log("No data available");
document.getElementById('main').style.display="none";
document.getElementById('head1').innerHTML=`Nothing Added to Cart <h3>add now and start moosing</h3> <a class="btn custom-btn smoothscroll mt-3" href="index.html"> back to homepage </a>`;



}
}).catch((error) => {
console.error(error);
window.location.replace('error.html');
});

</script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
    
   // Initialize Firebase
var firebseConfig = {
  // Your Firebase configuration here
  apiKey: "AIzaSyBQ75mL_tGG7DHgjh3u0_n_m-H6i3Qg_xM",
authDomain: "test-pastmoos.firebaseapp.com",
databaseURL: "https://test-pastmoos-default-rtdb.firebaseio.com",
projectId: "test-pastmoos",
storageBucket: "test-pastmoos.appspot.com",
messagingSenderId: "130244640247",
appId: "1:130244640247:web:62192c97a93d81ba95c2f2",
measurementId: "G-XFD7NKTDZV"
};
firebase.initializeApp(firebseConfig);
var database = firebase.database();

// Get a reference to the "Cart" node
function remove(i){
    var idn= document.getElementById('id'+ i).textContent;
    database.ref('Cart/'+ idn).remove().then(()=>{
location.reload();


    });
}
 // Fetch Cart data from Firebase RDB
 const cartRef = database.ref('Cart').orderByChild('phone').equalTo(sessionStorage.getItem('userloggedin'));
      cartRef.on('value', (snapshot) => {
        const cart = snapshot.val();

        // Compute total disprice
        let total = 0;
        for (const key in cart) {
          if (cart.hasOwnProperty(key)) {
            const dispriceStr = cart[key].disprice.trim().replace('Rs.', '');
            const dispriceNum = Number(dispriceStr);
            total += dispriceNum;
          }
        }

        const totalElem = document.getElementById('total');
        totalElem.textContent = `Total Price: Rs. ${total}`;
        document.getElementById('totprice').textContent= `${total}`
      });

      function validateForm() {
            var pincoden= document.getElementById("pincode").value;
			var pincode = document.getElementById("pincode").value;
            var totalfinal= document.getElementById('totprice').textContent;
            var name = document.getElementById("name").value;
  var email = document.getElementById("email").value;
  var pincode = document.getElementById("pincode").value;
  var address1 = document.getElementById("address1").value;
  var address2 = document.getElementById("address2").value;
  var state = document.getElementById("state").value;
  var city = document.getElementById("city").value;
  var payment = document.getElementById("payment").value;
  var emailPattern = /^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/;
  if (name == "" || email == "" || pincode == "" || address1 == "" || address2 == "" || state == "" || city == "" || payment == "") {
    alert("Please fill in all required fields.");
    return false;
  }
  else if (!emailPattern.test(email)) {
    alert("Please enter a valid email address.");
    return false;
  }
		else if (pincode.length !== 6 || isNaN(pincode)) {
				alert("Please enter a valid 6-digit pincode.");
				return false;
			}
		else if (document.getElementById("payment").value === "online") {
				// Run online payment code here
	// 			alert("Online payment code will be executed.");
  //       console.log(totalfinal);
                
  //               // 				const data = JSON.stringify({
  //               //   data: {
  //               //     pincode: pincoden,
  //               //     access_token: 'bdf8a98e100c3df26ef69290849639d0',
  //               //     secret_key: 'f6a4123ac76bbd4f10dd296f03c0d047',
  //               //   },
  //               // });
                
  //               // fetch('https://my.ithinklogistics.com/api_v3/pincode/check.json', {
  //               //   method: 'POST',
  //               //   headers: {
  //               //     'Content-Type': 'application/json',
  //               //   },
  //               //   body: data,
  //               // })
  //               // .then(response => response.json())
  //               //   .then(data => console.log(data))
  //               //   .catch(error => console.error(error));
  //               const params = new URLSearchParams({
  //                   from_pincode: '560078',
  //                   to_pincode: pincoden,
  //                   shipping_length_cms: '12',
  //                   shipping_width_cms: '8',
  //                   shipping_height_cms: '2',
  //                   shipping_weight_kg: '0.5',
  //                   order_type: 'forward',
  //                   payment_method: 'prepaid',
  //                   product_mrp: totalfinal,
  //                   access_token: 'bdf8a98e100c3df26ef69290849639d0',
  //                   secret_key: 'f6a4123ac76bbd4f10dd296f03c0d047'
  //               });
  //               fetch(`getrate.php?${params}`)
  // .then(response => {
  //   if (!response.ok) {
  //     throw new Error(`HTTP error! status: ${response.status}`);
  //   }
  //   return response.json();
  // })
  // .then(data => {
  //   const apiResponse = data;
  //   const minRate = displayMinRateDetails(apiResponse);
  //   console.log(`Minimum rate: ${minRate.rate}`);
  //   console.log(`Logistic provider: ${minRate.logistic_name}`);
  //   const totalToPay = parseInt(totalfinal) + parseInt(minRate.rate);
                
  //                   document.getElementById("final-amount").innerHTML = `
  //               <center>
  //               <table class='totpaydiv'>
  //                     <h3>Product price: ${totalfinal}</h3>
  //                     <hr>
  //                     <h3>Delivery charge: ${minRate.rate}</h3>
  //                     <hr>
  //                     <h3>Total to pay: ${totalToPay}</h3>
  //                     <table>
  //                       </center>
  //                   `;;
  //                   // Extract data array from API response
                
                    
                
  //               })
  //                 .catch(error => console.error(error));
                
                
                alert('online payment will be available soon, select cod');
                } 
               
        
			 else {
				// Run COD payment code here

              document.getElementById('placeorderbtn').style.display='block';
              document.getElementById('placeorderbtn').scrollIntoView({behavior: "smooth", block: "start", inline: "nearest"});
                console.log(totalfinal);
                
// 				const data = JSON.stringify({
//   data: {
//     pincode: pincoden,
//     access_token: 'bdf8a98e100c3df26ef69290849639d0',
//     secret_key: 'f6a4123ac76bbd4f10dd296f03c0d047',
//   },
// });

// fetch('https://my.ithinklogistics.com/api_v3/pincode/check.json', {
//   method: 'POST',
//   headers: {
//     'Content-Type': 'application/json',
//   },
//   body: data,
// })
// .then(response => response.json())
//   .then(data => console.log(data))
//   .catch(error => console.error(error));
const params = new URLSearchParams({
    from_pincode: '560078',
    to_pincode: pincoden,
    shipping_length_cms: '12',
    shipping_width_cms: '8',
    shipping_height_cms: '2',
    shipping_weight_kg: '0.5',
    order_type: 'forward',
    payment_method: 'cod',
    product_mrp: totalfinal,
    access_token: 'bdf8a98e100c3df26ef69290849639d0',
    secret_key: 'f6a4123ac76bbd4f10dd296f03c0d047'
});

fetch(`getrate.php?${params}`)
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    const apiResponse = data;
    const minRate = displayMinRateDetails(apiResponse);
    console.log(`Minimum rate: ${minRate.rate}`);
    console.log(`Logistic provider: ${minRate.logistic_name}`);
    const logistics = minRate.logistic_name;
    sessionStorage.setItem('logistics',logistics);
    var totalToPay = parseInt(totalfinal) + parseInt(minRate.rate);
    if(totalToPay>349){
                    
                      totalToPay= parseInt(totalfinal);
                    }
                    

    document.getElementById("final-amount").innerHTML =  `
                <center>
                <table class='totpaydiv'>
                      <h3>Product price: Rs.${totalfinal}</h3>
                      <hr>
                      <p style='color:green' id='freedelmsg'> Order aboe 349 and get free delivery <p>
                        <h5 style='color:green;' id='freedelamt'>order more for Rs. ${349-totalToPay} and get free delivery</h5>
                      <h3 id='delch'>Delivery charge:Rs. ${minRate.rate}</h3>
                      <hr>
                    
                      <h3>Total to pay:<h3 id='totaltopayid' value='${totalToPay}'>Rs. ${totalToPay}</h3></h3>
                      <table>
                        </center>
                    `;
                    if(totalToPay>349){
                      document.getElementById('freedelmsg').style.display='none';
                      document.getElementById('freedelamt').innerHTML=`Congratulations! you unlocked free delivery`;
                      document.getElementById('delch').innerHTML=`Delivery charge:Rs.0`;

                   
                    }
                  
  })
  .catch(error => console.error(error));
}};

function displayMinRateDetails(apiResponse) {
  const data1 = apiResponse.data;

  // Initialize minimum rate and corresponding logistic name to large values
  let minRate = Number.MAX_VALUE;
  let minRateIndex = -1;
  let minRateLogisticName = '';

  // Loop through the data array and find the minimum rate
  for (let i = 0; i < data1.length; i++) {
    const rate = data1[i].rate;
    if (rate < minRate) {
      minRate = rate;
      minRateIndex = i;
      minRateLogisticName = data1[i].logistic_name;
    }
  }

  // Extract details of the minimum rate
  const minRateDetails = data1[minRateIndex];

  // Display details of the minimum rate using HTML
  const html = `

`;

  // Display HTML in a div element with id "min-rate-details"
  document.getElementById("min-rate-details").innerHTML = html;

  // Return an object with the minimum rate and its corresponding logistic name
  return { rate: minRate, logistic_name: minRateLogisticName };
}

function placeorder() {
  // Create a new Date object
  const now = new Date();

  // Get the current minutes and seconds, padded with leading zeros if necessary
  const minutes = now.getMinutes().toString().padStart(2, "0");
  const seconds = now.getSeconds().toString().padStart(2, "0");

  // Format the date as a string (in MM/DD/YYYY format)
  const dateStr = `${now.getMonth() + 1}${now.getDate()}${now.getFullYear()}`;
  const date=`${now.getDate()}-${now.getMonth() + 1}-${now.getFullYear()}`

  // Combine the date, minutes, and seconds into a single string
  const combinedStr = `${dateStr}${minutes}${seconds}`;

  // Print the combined string to the console
  console.log(combinedStr);
  totalToPay= document.getElementById('totaltopayid').value;
logistics= sessionStorage.getItem('logistics');
  const url = "https://my.ithinklogistics.com/api_v3/order/add.json";
const data = {
  "data": {
    "shipments": [
      {
        "waybill": 'pastmoos'+combinedStr ,
        "order": combinedStr,
        "order_date":date,
        "total_amount": totalToPay,
        "name": document.getElementById('name').value,
        "add": document.getElementById('address1').value,
        "add2": document.getElementById('address2').value,
        "pin": document.getElementById('pincode').value,
        "phone": sessionStorage.getItem('userloggedin'),
        "email": document.getElementById('email').value,
        "is_billing_same_as_shipping": "yes",
        "products": [],
        "shipment_length": "12",
        "shipment_width": "8",
        "shipment_height": "2",
        "weight": "0.5",
        "cod_amount": totalToPay ,
        "payment_mode": "cod",
        "return_address_id": "40569"
      }
    ],
    "pickup_address_id": "40569",
    "access_token": "bdf8a98e100c3df26ef69290849639d0",
    "secret_key": "f6a4123ac76bbd4f10dd296f03c0d047",
    "logistics": logistics,
    "s_type": "ground",
    "order_type": ""
    
  }
};
console.log(data);

// Add products dynamically

const db = firebase.database();
const cartRef = db.ref('Cart').orderByChild('phone').equalTo(sessionStorage.getItem('userloggedin'));
cartRef.once('value', snapshot => {
  snapshot.forEach(childSnapshot => {
    const product = childSnapshot.val();
    data.data.shipments[0].products.push({
      "product_name": product.productName,
      "product_quantity": product.quant.toString(),
      "product_price": product.disprice.toString()
    });
  });
}).then(() => {
const options = {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(data),
};

fetch(url, options)
  .then(response => response.json())
  .then(data => {console.log(data.status);
  if(data.status=='success'){
   
   
database
.ref("Orders/"+ sessionStorage.getItem('userloggedin'))
.set({

phone:sessionStorage.getItem('userloggedin'),
awb: 'pastmoos'+combinedStr

})

.then(() => {
console.log("Product saved to Firebase Database");
window.location.href='success.html'
});

  }else{
    alert('order not placed, try again after some time');
  }
  
  })
  .catch(error => console.error(error));

}).catch(error => {console.error(error); window.location.replace('error.html');})};

</script>

    <script>
     
   


    </script>
</body>
</html>
